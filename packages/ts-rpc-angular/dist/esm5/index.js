import * as tslib_1 from "tslib";
import { BEFORE_APP_SERIALIZED } from '@angular/platform-server';
import { NgModule, APP_ID } from '@angular/core';
import { ɵescapeHtml as escapeHtml, } from '@angular/platform-browser';
import { DOCUMENT } from '@angular/common';
import { ɵTransferState } from 'ts-rpc-reflect';
var getCacheKey = function (className, propName, args) {
    return className + "#" + propName + "#" + JSON.stringify(args);
};
var ɵ0 = getCacheKey;
export function serializeTransferStateFactory(doc, appId) {
    console.log('#######');
    return function () {
        console.log('Adding state to the DOM');
        var script = doc.createElement('script');
        script.id = appId + '-rpc';
        script.setAttribute('type', 'application/json');
        script.textContent = escapeHtml(JSON.stringify(data));
        doc.body.appendChild(script);
    };
}
function getTransferStateDescriptors(klass) {
    var protoChain = [];
    var proto = klass.prototype;
    while (proto) {
        protoChain.push(proto);
        proto = Object.getPrototypeOf(proto);
    }
    var result = [];
    var descriptors = Object.getOwnPropertyDescriptors(klass.prototype);
    Object.keys(descriptors).forEach(function (name) {
        var exists = protoChain.some(function (proto) {
            var current = Object.getOwnPropertyDescriptor(proto, name);
            return current && current.value[ɵTransferState];
        });
        if (exists) {
            result.push(name);
        }
    });
    return result;
}
;
var data = {};
export function wrapServices(providers) {
    providers.forEach(function (p) {
        if (!p.useClass) {
            return;
        }
        var provider = p;
        // if (provider.useClass instanceof Service) {
        //   return;
        // }
        var descriptors = getTransferStateDescriptors(provider.useClass);
        console.log('Decorating', descriptors.length, 'methods');
        var proto = provider.useClass.prototype;
        descriptors.forEach(function (propName) {
            console.log('Decorating method');
            var original = proto[propName];
            console.log(original.toString());
            if (proto[propName].__DECORATED__) {
                return;
            }
            proto[propName] = function () {
                console.log('Delegating to original');
                console.trace();
                var args = arguments;
                return original.apply(this, arguments).then(function (res) {
                    console.log('Setting state key');
                    data[getCacheKey(proto.constructor.name, propName, args)] = JSON.stringify(res);
                    return res;
                });
            };
            proto[propName].__DECORATED__ = true;
        });
    });
    return providers;
}
;
var TSRPCAngularModule = /** @class */ (function () {
    function TSRPCAngularModule() {
    }
    TSRPCAngularModule_1 = TSRPCAngularModule;
    TSRPCAngularModule.register = function () {
        var providers = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            providers[_i] = arguments[_i];
        }
        return {
            ngModule: TSRPCAngularModule_1,
            providers: [
                providers,
                {
                    provide: BEFORE_APP_SERIALIZED,
                    useFactory: serializeTransferStateFactory,
                    deps: [DOCUMENT, APP_ID],
                    multi: true
                }
            ]
        };
    };
    var TSRPCAngularModule_1;
    TSRPCAngularModule = TSRPCAngularModule_1 = tslib_1.__decorate([
        NgModule({})
    ], TSRPCAngularModule);
    return TSRPCAngularModule;
}());
export { TSRPCAngularModule };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly90cy1ycGMtYW5ndWxhci8iLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBZ0QsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUNMLFdBQVcsSUFBSSxVQUFVLEdBQzFCLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBVyxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RCxJQUFNLFdBQVcsR0FBRyxVQUFDLFNBQWlCLEVBQUUsUUFBZ0IsRUFBRSxJQUFTO0lBQ2pFLE9BQVUsU0FBUyxTQUFJLFFBQVEsU0FBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBRyxDQUFDO0FBQzVELENBQUMsQ0FBQzs7QUFFRixNQUFNLFVBQVUsNkJBQTZCLENBQzNDLEdBQWEsRUFDYixLQUFhO0lBRWIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2QixPQUFPO1FBQ0wsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQ3ZDLElBQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsTUFBTSxDQUFDLEVBQUUsR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RELEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxD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QUMsQ0FBQztZQUNGLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBQUEsQ0FBQztBQUdGO0lBQUE7SUFlQSxDQUFDOzJCQWZZLGtCQUFrQjtJQUN0QiwyQkFBUSxHQUFmO1FBQWdCLG1CQUF3QjthQUF4QixVQUF3QixFQUF4QixxQkFBd0IsRUFBeEIsSUFBd0I7WUFBeEIsOEJBQXdCOztRQUN0QyxPQUFPO1lBQ0wsUUFBUSxFQUFFLG9CQUFrQjtZQUM1QixTQUFTLEVBQUU7Z0JBQ1QsU0FBUztnQkFDVDtvQkFDRSxPQUFPLEVBQUUscUJBQXFCO29CQUM5QixVQUFVLEVBQUUsNkJBQTZCO29CQUN6QyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDO29CQUN4QixLQUFLLEVBQUUsSUFBSTtpQkFDWjthQUNGO1NBQ0YsQ0FBQTtJQUNILENBQUM7O0lBZFUsa0JBQWtCO1FBRDlCLFFBQVEsQ0FBQyxFQUFFLENBQUM7T0FDQSxrQkFBa0IsQ0FlOUI7SUFBRCx5QkFBQztDQUFBLEFBZkQsSUFlQztTQWZZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJFRk9SRV9BUFBfU0VSSUFMSVpFRCB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLXNlcnZlcic7XG5pbXBvcnQgeyBOZ01vZHVsZSwgQVBQX0lELCBQcm92aWRlciwgQ2xhc3NQcm92aWRlciwgTW9kdWxlV2l0aFByb3ZpZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgybVlc2NhcGVIdG1sIGFzIGVzY2FwZUh0bWwsXG59IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgU2VydmljZSwgybVUcmFuc2ZlclN0YXRlIH0gZnJvbSAndHMtcnBjLXJlZmxlY3QnO1xuXG5jb25zdCBnZXRDYWNoZUtleSA9IChjbGFzc05hbWU6IHN0cmluZywgcHJvcE5hbWU6IHN0cmluZywgYXJnczogYW55KSA9PiB7XG4gIHJldHVybiBgJHtjbGFzc05hbWV9IyR7cHJvcE5hbWV9IyR7SlNPTi5zdHJpbmdpZnkoYXJncyl9YDtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVUcmFuc2ZlclN0YXRlRmFjdG9yeShcbiAgZG9jOiBEb2N1bWVudCxcbiAgYXBwSWQ6IHN0cmluZyxcbikge1xuICBjb25zb2xlLmxvZygnIyMjIyMjIycpO1xuICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgc3RhdGUgdG8gdGhlIERPTScpO1xuICAgIGNvbnN0IHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBzY3JpcHQuaWQgPSBhcHBJZCArICctcnBjJztcbiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICBzY3JpcHQudGV4dENvbnRlbnQgPSBlc2NhcGVIdG1sKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRUcmFuc2ZlclN0YXRlRGVzY3JpcHRvcnMoa2xhc3M6IEZ1bmN0aW9uKSB7XG4gIGNvbnN0IHByb3RvQ2hhaW46IE9iamVjdFtdID0gW107XG4gIGxldCBwcm90byA9IGtsYXNzLnByb3RvdHlwZTtcbiAgd2hpbGUgKHByb3RvKSB7XG4gICAgcHJvdG9DaGFpbi5wdXNoKHByb3RvKTtcbiAgICBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90byk7XG4gIH1cbiAgY29uc3QgcmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKGtsYXNzLnByb3RvdHlwZSk7XG4gIE9iamVjdC5rZXlzKGRlc2NyaXB0b3JzKS5mb3JFYWNoKG5hbWUgPT4ge1xuICAgIGNvbnN0IGV4aXN0cyA9IHByb3RvQ2hhaW4uc29tZShwcm90byA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bywgbmFtZSk7XG4gICAgICByZXR1cm4gY3VycmVudCAmJiBjdXJyZW50LnZhbHVlW8m1VHJhbnNmZXJTdGF0ZV07XG4gICAgfSk7XG4gICAgaWYgKGV4aXN0cykge1xuICAgICAgcmVzdWx0LnB1c2gobmFtZSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IGRhdGE6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIHdyYXBTZXJ2aWNlcyhwcm92aWRlcnM6IFByb3ZpZGVyW10pOiBhbnkge1xuICBwcm92aWRlcnMuZm9yRWFjaCgocDogUHJvdmlkZXIpID0+IHtcbiAgICBpZiAoIShwIGFzIENsYXNzUHJvdmlkZXIpLnVzZUNsYXNzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHByb3ZpZGVyID0gcCBhcyBDbGFzc1Byb3ZpZGVyO1xuICAgIC8vIGlmIChwcm92aWRlci51c2VDbGFzcyBpbnN0YW5jZW9mIFNlcnZpY2UpIHtcbiAgICAvLyAgIHJldHVybjtcbiAgICAvLyB9XG5cbiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IGdldFRyYW5zZmVyU3RhdGVEZXNjcmlwdG9ycyhwcm92aWRlci51c2VDbGFzcyk7XG5cbiAgICBjb25zb2xlLmxvZygnRGVjb3JhdGluZycsIGRlc2NyaXB0b3JzLmxlbmd0aCwgJ21ldGhvZHMnKTtcbiAgICBjb25zdCBwcm90byA9IHByb3ZpZGVyLnVzZUNsYXNzLnByb3RvdHlwZTtcbiAgICBkZXNjcmlwdG9ycy5mb3JFYWNoKHByb3BOYW1lID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdEZWNvcmF0aW5nIG1ldGhvZCcpO1xuICAgICAgY29uc3Qgb3JpZ2luYWwgPSBwcm90b1twcm9wTmFtZV0gYXMgRnVuY3Rpb247XG4gICAgICBjb25zb2xlLmxvZyhvcmlnaW5hbC50b1N0cmluZygpKTtcbiAgICAgIGlmIChwcm90b1twcm9wTmFtZV0uX19ERUNPUkFURURfXykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBwcm90b1twcm9wTmFtZV0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0RlbGVnYXRpbmcgdG8gb3JpZ2luYWwnKTtcbiAgICAgICAgY29uc29sZS50cmFjZSgpO1xuICAgICAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzO1xuICAgICAgICByZXR1cm4gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJndW1lbnRzKS50aGVuKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdTZXR0aW5nIHN0YXRlIGtleScpO1xuICAgICAgICAgIGRhdGFbZ2V0Q2FjaGVLZXkocHJvdG8uY29uc3RydWN0b3IubmFtZSwgcHJvcE5hbWUsIGFyZ3MpXSA9IEpTT04uc3RyaW5naWZ5KHJlcyk7XG4gICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgcHJvdG9bcHJvcE5hbWVdLl9fREVDT1JBVEVEX18gPSB0cnVlO1xuICAgIH0pO1xuICB9KTtcbiAgcmV0dXJuIHByb3ZpZGVycztcbn07XG5cbkBOZ01vZHVsZSh7fSlcbmV4cG9ydCBjbGFzcyBUU1JQQ0FuZ3VsYXJNb2R1bGUge1xuICBzdGF0aWMgcmVnaXN0ZXIoLi4ucHJvdmlkZXJzOiBQcm92aWRlcltdKTogTW9kdWxlV2l0aFByb3ZpZGVycyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5nTW9kdWxlOiBUU1JQQ0FuZ3VsYXJNb2R1bGUsXG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgcHJvdmlkZXJzLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQkVGT1JFX0FQUF9TRVJJQUxJWkVELFxuICAgICAgICAgIHVzZUZhY3Rvcnk6IHNlcmlhbGl6ZVRyYW5zZmVyU3RhdGVGYWN0b3J5LFxuICAgICAgICAgIGRlcHM6IFtET0NVTUVOVCwgQVBQX0lEXSxcbiAgICAgICAgICBtdWx0aTogdHJ1ZVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfVxuICB9XG59XG4iXX0=