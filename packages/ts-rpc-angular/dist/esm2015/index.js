var TSRPCAngularModule_1;
import * as tslib_1 from "tslib";
import { BEFORE_APP_SERIALIZED } from '@angular/platform-server';
import { NgModule, APP_ID } from '@angular/core';
import { ɵescapeHtml as escapeHtml, } from '@angular/platform-browser';
import { DOCUMENT } from '@angular/common';
import { ɵTransferState } from 'ts-rpc-reflect';
const getCacheKey = (className, propName, args) => {
    return `${className}#${propName}#${JSON.stringify(args)}`;
};
const ɵ0 = getCacheKey;
export function serializeTransferStateFactory(doc, appId) {
    console.log('#######');
    return function () {
        console.log('Adding state to the DOM');
        const script = doc.createElement('script');
        script.id = appId + '-rpc';
        script.setAttribute('type', 'application/json');
        script.textContent = escapeHtml(JSON.stringify(data));
        doc.body.appendChild(script);
    };
}
function getTransferStateDescriptors(klass) {
    const protoChain = [];
    let proto = klass.prototype;
    while (proto) {
        protoChain.push(proto);
        proto = Object.getPrototypeOf(proto);
    }
    const result = [];
    const descriptors = Object.getOwnPropertyDescriptors(klass.prototype);
    Object.keys(descriptors).forEach(name => {
        const exists = protoChain.some(proto => {
            const current = Object.getOwnPropertyDescriptor(proto, name);
            return current && current.value[ɵTransferState];
        });
        if (exists) {
            result.push(name);
        }
    });
    return result;
}
;
const data = {};
export function wrapServices(providers) {
    providers.forEach((p) => {
        if (!p.useClass) {
            return;
        }
        const provider = p;
        // if (provider.useClass instanceof Service) {
        //   return;
        // }
        const descriptors = getTransferStateDescriptors(provider.useClass);
        console.log('Decorating', descriptors.length, 'methods');
        const proto = provider.useClass.prototype;
        descriptors.forEach(propName => {
            console.log('Decorating method');
            const original = proto[propName];
            console.log(original.toString());
            if (proto[propName].__DECORATED__) {
                return;
            }
            proto[propName] = function () {
                console.log('Delegating to original');
                console.trace();
                const args = arguments;
                return original.apply(this, arguments).then((res) => {
                    console.log('Setting state key');
                    data[getCacheKey(proto.constructor.name, propName, args)] = JSON.stringify(res);
                    return res;
                });
            };
            proto[propName].__DECORATED__ = true;
        });
    });
    return providers;
}
;
let TSRPCAngularModule = TSRPCAngularModule_1 = class TSRPCAngularModule {
    static register(...providers) {
        return {
            ngModule: TSRPCAngularModule_1,
            providers: [
                providers,
                {
                    provide: BEFORE_APP_SERIALIZED,
                    useFactory: serializeTransferStateFactory,
                    deps: [DOCUMENT, APP_ID],
                    multi: true
                }
            ]
        };
    }
};
TSRPCAngularModule = TSRPCAngularModule_1 = tslib_1.__decorate([
    NgModule({})
], TSRPCAngularModule);
export { TSRPCAngularModule };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly90cy1ycGMtYW5ndWxhci8iLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDakUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQWdELE1BQU0sZUFBZSxDQUFDO0FBQy9GLE9BQU8sRUFDTCxXQUFXLElBQUksVUFBVSxHQUMxQixNQUFNLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQVcsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxTQUFpQixFQUFFLFFBQWdCLEVBQUUsSUFBUyxFQUFFLEVBQUU7SUFDckUsT0FBTyxHQUFHLFNBQVMsSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQzVELENBQUMsQ0FBQzs7QUFFRixNQUFNLFVBQVUsNkJBQTZCLENBQzNDLEdBQWEsRUFDYixLQUFhO0lBRWIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2QixPQUFPO1FBQ0wsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsTUFBTSxDQUFDLEVBQUUsR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RELEdBQUcsQ0FBQyxJQUFJLENBQUMs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LENBQUM7b0JBQ2hGLE9BQU8sR0FBRyxDQUFDO2dCQUNiLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDO1lBQ0YsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFBQSxDQUFDO0FBR0YsSUFBYSxrQkFBa0IsMEJBQS9CLE1BQWEsa0JBQWtCO0lBQzdCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxTQUFxQjtRQUN0QyxPQUFPO1lBQ0wsUUFBUSxFQUFFLG9CQUFrQjtZQUM1QixTQUFTLEVBQUU7Z0JBQ1QsU0FBUztnQkFDVDtvQkFDRSxPQUFPLEVBQUUscUJBQXFCO29CQUM5QixVQUFVLEVBQUUsNkJBQTZCO29CQUN6QyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDO29CQUN4QixLQUFLLEVBQUUsSUFBSTtpQkFDWjthQUNGO1NBQ0YsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFBO0FBZlksa0JBQWtCO0lBRDlCLFFBQVEsQ0FBQyxFQUFFLENBQUM7R0FDQSxrQkFBa0IsQ0FlOUI7U0FmWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCRUZPUkVfQVBQX1NFUklBTElaRUQgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1zZXJ2ZXInO1xuaW1wb3J0IHsgTmdNb2R1bGUsIEFQUF9JRCwgUHJvdmlkZXIsIENsYXNzUHJvdmlkZXIsIE1vZHVsZVdpdGhQcm92aWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIMm1ZXNjYXBlSHRtbCBhcyBlc2NhcGVIdG1sLFxufSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IFNlcnZpY2UsIMm1VHJhbnNmZXJTdGF0ZSB9IGZyb20gJ3RzLXJwYy1yZWZsZWN0JztcblxuY29uc3QgZ2V0Q2FjaGVLZXkgPSAoY2xhc3NOYW1lOiBzdHJpbmcsIHByb3BOYW1lOiBzdHJpbmcsIGFyZ3M6IGFueSkgPT4ge1xuICByZXR1cm4gYCR7Y2xhc3NOYW1lfSMke3Byb3BOYW1lfSMke0pTT04uc3RyaW5naWZ5KGFyZ3MpfWA7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplVHJhbnNmZXJTdGF0ZUZhY3RvcnkoXG4gIGRvYzogRG9jdW1lbnQsXG4gIGFwcElkOiBzdHJpbmcsXG4pIHtcbiAgY29uc29sZS5sb2coJyMjIyMjIyMnKTtcbiAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zb2xlLmxvZygnQWRkaW5nIHN0YXRlIHRvIHRoZSBET00nKTtcbiAgICBjb25zdCBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgc2NyaXB0LmlkID0gYXBwSWQgKyAnLXJwYyc7XG4gICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgc2NyaXB0LnRleHRDb250ZW50ID0gZXNjYXBlSHRtbChKU09OLnN0cmluZ2lmeShkYXRhKSk7XG4gICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0VHJhbnNmZXJTdGF0ZURlc2NyaXB0b3JzKGtsYXNzOiBGdW5jdGlvbikge1xuICBjb25zdCBwcm90b0NoYWluOiBPYmplY3RbXSA9IFtdO1xuICBsZXQgcHJvdG8gPSBrbGFzcy5wcm90b3R5cGU7XG4gIHdoaWxlIChwcm90bykge1xuICAgIHByb3RvQ2hhaW4ucHVzaChwcm90byk7XG4gICAgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8pO1xuICB9XG4gIGNvbnN0IHJlc3VsdDogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgZGVzY3JpcHRvcnMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhrbGFzcy5wcm90b3R5cGUpO1xuICBPYmplY3Qua2V5cyhkZXNjcmlwdG9ycykuZm9yRWFjaChuYW1lID0+IHtcbiAgICBjb25zdCBleGlzdHMgPSBwcm90b0NoYWluLnNvbWUocHJvdG8gPT4ge1xuICAgICAgY29uc3QgY3VycmVudCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8sIG5hbWUpO1xuICAgICAgcmV0dXJuIGN1cnJlbnQgJiYgY3VycmVudC52YWx1ZVvJtVRyYW5zZmVyU3RhdGVdO1xuICAgIH0pO1xuICAgIGlmIChleGlzdHMpIHtcbiAgICAgIHJlc3VsdC5wdXNoKG5hbWUpO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBkYXRhOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbmV4cG9ydCBmdW5jdGlvbiB3cmFwU2VydmljZXMocHJvdmlkZXJzOiBQcm92aWRlcltdKTogYW55IHtcbiAgcHJvdmlkZXJzLmZvckVhY2goKHA6IFByb3ZpZGVyKSA9PiB7XG4gICAgaWYgKCEocCBhcyBDbGFzc1Byb3ZpZGVyKS51c2VDbGFzcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBwcm92aWRlciA9IHAgYXMgQ2xhc3NQcm92aWRlcjtcbiAgICAvLyBpZiAocHJvdmlkZXIudXNlQ2xhc3MgaW5zdGFuY2VvZiBTZXJ2aWNlKSB7XG4gICAgLy8gICByZXR1cm47XG4gICAgLy8gfVxuXG4gICAgY29uc3QgZGVzY3JpcHRvcnMgPSBnZXRUcmFuc2ZlclN0YXRlRGVzY3JpcHRvcnMocHJvdmlkZXIudXNlQ2xhc3MpO1xuXG4gICAgY29uc29sZS5sb2coJ0RlY29yYXRpbmcnLCBkZXNjcmlwdG9ycy5sZW5ndGgsICdtZXRob2RzJyk7XG4gICAgY29uc3QgcHJvdG8gPSBwcm92aWRlci51c2VDbGFzcy5wcm90b3R5cGU7XG4gICAgZGVzY3JpcHRvcnMuZm9yRWFjaChwcm9wTmFtZSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnRGVjb3JhdGluZyBtZXRob2QnKTtcbiAgICAgIGNvbnN0IG9yaWdpbmFsID0gcHJvdG9bcHJvcE5hbWVdIGFzIEZ1bmN0aW9uO1xuICAgICAgY29uc29sZS5sb2cob3JpZ2luYWwudG9TdHJpbmcoKSk7XG4gICAgICBpZiAocHJvdG9bcHJvcE5hbWVdLl9fREVDT1JBVEVEX18pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgcHJvdG9bcHJvcE5hbWVdID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdEZWxlZ2F0aW5nIHRvIG9yaWdpbmFsJyk7XG4gICAgICAgIGNvbnNvbGUudHJhY2UoKTtcbiAgICAgICAgY29uc3QgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgcmV0dXJuIG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykudGhlbigocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU2V0dGluZyBzdGF0ZSBrZXknKTtcbiAgICAgICAgICBkYXRhW2dldENhY2hlS2V5KHByb3RvLmNvbnN0cnVjdG9yLm5hbWUsIHByb3BOYW1lLCBhcmdzKV0gPSBKU09OLnN0cmluZ2lmeShyZXMpO1xuICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIHByb3RvW3Byb3BOYW1lXS5fX0RFQ09SQVRFRF9fID0gdHJ1ZTtcbiAgICB9KTtcbiAgfSk7XG4gIHJldHVybiBwcm92aWRlcnM7XG59O1xuXG5ATmdNb2R1bGUoe30pXG5leHBvcnQgY2xhc3MgVFNSUENBbmd1bGFyTW9kdWxlIHtcbiAgc3RhdGljIHJlZ2lzdGVyKC4uLnByb3ZpZGVyczogUHJvdmlkZXJbXSk6IE1vZHVsZVdpdGhQcm92aWRlcnMge1xuICAgIHJldHVybiB7XG4gICAgICBuZ01vZHVsZTogVFNSUENBbmd1bGFyTW9kdWxlLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHByb3ZpZGVycyxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEJFRk9SRV9BUFBfU0VSSUFMSVpFRCxcbiAgICAgICAgICB1c2VGYWN0b3J5OiBzZXJpYWxpemVUcmFuc2ZlclN0YXRlRmFjdG9yeSxcbiAgICAgICAgICBkZXBzOiBbRE9DVU1FTlQsIEFQUF9JRF0sXG4gICAgICAgICAgbXVsdGk6IHRydWVcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH1cbiAgfVxufVxuIl19